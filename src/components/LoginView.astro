---
// LoginView.astro
---

<div class="login-container">
    <div class="login-card">
        
        <!-- BRANDING -->
        <div class="brand-header">
            <!-- Mountain Icon (SVG) - Minimalist -->
            <div class="mountain-icon">
                <svg viewBox="0 0 100 100" width="70" height="70">
                     <path d="M50 20 L80 80 H20 Z" fill="#ea580c"/>
                     <path d="M50 20 L65 80 L50 60 L35 80 Z" fill="#0f172a" opacity="0.3"/> 
                </svg>
            </div>
            
            <h1 class="brand-title">
                <span class="brand-white">PATAGONIA</span>
                <span class="brand-orange">TRACKER</span>
            </h1>
            <p class="brand-subtitle">PREPARACIÓN FÍSICA 2026</p>
        </div>

        <!-- FORM -->
        <div class="login-form">
            <input type="email" id="email" class="std-box" placeholder="danielaranadj@gmail.com" />
            <input type="password" id="password" class="std-box" placeholder="Contraseña" />

            <button id="loginBtn" class="std-box login-btn">
                INICIAR SESIÓN
            </button>
            
            <div class="toggle-area">
                <span id="toggleText">¿No tienes cuenta?</span>
                <button id="toggleBtn" class="link-btn">Regístrate</button>
            </div>

            <p id="errorMsg" class="error-msg hidden"></p>
        </div>

    </div>
</div>

<script>
    import { loginUser, registerUser } from '../stores/trainingStore';

    const emailInp = document.getElementById('email') as HTMLInputElement;
    const passInp = document.getElementById('password') as HTMLInputElement;
    const btn = document.getElementById('loginBtn');
    const toggleBtn = document.getElementById('toggleBtn');
    const msg = document.getElementById('errorMsg');
    
    let isRegisterMode = false;

    if(toggleBtn) {
        toggleBtn.onclick = () => {
             isRegisterMode = !isRegisterMode;
             if(isRegisterMode) {
                 btn.innerText = "CREAR CUENTA";
                 document.getElementById('toggleText').innerText = "¿Ya tienes cuenta?";
                 toggleBtn.innerText = "Inicia Sesión";
             } else {
                 btn.innerText = "INICIAR SESIÓN";
                 document.getElementById('toggleText').innerText = "¿No tienes cuenta?";
                 toggleBtn.innerText = "Regístrate";
             }
             msg.classList.add('hidden');
        };
    }

    if(btn) {
        btn.onclick = async () => {
             const actionName = isRegisterMode ? "CREANDO..." : "ENTRANDO...";
             const resetName = isRegisterMode ? "CREAR CUENTA" : "INICIAR SESIÓN";
             
             btn.innerText = actionName;
             btn.setAttribute('disabled', 'true');
             msg.classList.add('hidden');
             
             try {
                 if(isRegisterMode) {
                    await registerUser(emailInp.value, passInp.value);
                 } else {
                    await loginUser(emailInp.value, passInp.value);
                 }
                 // Success handles automatically by auth state change
             } catch(e) {
                 console.error(e);
                 btn.innerText = resetName;
                 btn.removeAttribute('disabled');
                 
                 // User friendly errors
                 let text = "Error desconcido";
                 if(e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password') text = "Contraseña o Correo incorrectos.";
                 if(e.code === 'auth/user-not-found') text = "Usuario no encontrado. Regístrate primero.";
                 if(e.code === 'auth/email-already-in-use') text = "El correo ya está registrado.";
                 if(e.code === 'auth/invalid-email') text = "Correo inválido.";
                 if(e.code === 'auth/weak-password') text = "La contraseña debe tener 6+ caracteres.";
                 
                 // Show raw code if not matched, to help debug
                 if(text === "Error desconcido") text = `Error: ${e.code}`;

                 msg.innerText = text;
                 msg.classList.remove('hidden');
             }
        };
    }
</script>

<style>
    .login-container {
        height: 100vh; width: 100vw;
        display: flex; align-items: center; justify-content: center;
        background: #0f172a; 
        padding: 20px;
    }

    .login-card {
        width: 100%; max-width: 380px; 
        display: flex; flex-direction: column; align-items: center; gap: 40px;
    }

    /* BRANDING */
    .brand-header { text-align: center; }
    .mountain-icon { margin-bottom: 5px; opacity: 1; display:flex; justify-content:center; }

    .brand-title {
        font-family: 'Russo One', sans-serif;
        font-size: 2rem; 
        margin: 0; line-height: 1;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }
    .brand-white { color: white; }
    .brand-orange { color: #ea580c; }

    .brand-subtitle {
        font-family: 'Inter', sans-serif;
        color: #94a3b8;
        font-size: 0.75rem;
        letter-spacing: 2px;
        margin-top: 8px;
        text-transform: uppercase;
        font-weight: 600;
    }

    /* FORM standardized */
    .login-form { width: 100%; display: flex; flex-direction: column; gap: 15px; }

    .std-box {
        width: 100%;
        height: 52px; 
        padding: 0 15px; 
        box-sizing: border-box;
        border-radius: 6px;
        font-size: 1rem;
        border: 1px solid #334155;
    }

    input.std-box {
        background: rgba(30, 41, 59, 0.4);
        color: white;
        transition: 0.2s;
    }
    input.std-box:focus {
        border-color: #ea580c;
        outline: none;
        background: rgba(30, 41, 59, 0.8);
    }
    input::placeholder { color: #64748b; }

    button.std-box.login-btn {
        background: #ea580c;
        color: white;
        border: none;
        font-family: 'Russo One', sans-serif;
        text-transform: uppercase;
        cursor: pointer;
        font-size: 1.1rem;
        letter-spacing: 0.5px;
        transition: 0.2s;
        display: flex; align-items: center; justify-content: center;
    }
    button.std-box.login-btn:hover { background: #c2410c; }
    button.std-box.login-btn:active { transform: scale(0.98); }

    .error-msg { color: #ef4444; font-size: 0.9rem; text-align: center; margin-top: 10px; }
    
    .toggle-area {
        display: flex; justify-content: center; gap: 8px; font-size: 0.9rem; color: #94a3b8; margin-top: 5px;
    }
    .link-btn {
        background: none; border: none; color: #ea580c; 
        text-decoration: underline; cursor: pointer; font-family: 'Inter', sans-serif;
        padding: 0; font-size: 0.9rem;
    }
</style>
