---
import ActivityIcon from './ActivityIcon.astro';
---

<div class="stats-container">
    <h2 class="section-title">RENDIMIENTO</h2>

    <!-- TABS / FILTERS -->
    <div class="tabs-scroll">
        <button class="tab-btn active" data-filter="all">TODO</button>
        <button class="tab-btn" data-filter="running">RUN</button>
        <button class="tab-btn" data-filter="walking">WALK</button>
        <button class="tab-btn" data-filter="bike">BIKE</button>
        <button class="tab-btn" data-filter="hiking">HIKE</button>
        <button class="tab-btn" data-filter="gym">GYM</button>
    </div>

    <!-- MAIN METRICS CARD -->
    <div class="overview-card">
        <div class="ov-row">
            <div class="ov-item">
                <span class="ov-val" id="st-count">0</span>
                <span class="ov-lbl">SESIONES</span>
            </div>
            <div class="ov-item">
                <span class="ov-val" id="st-time">0h</span>
                <span class="ov-lbl">TIEMPO</span>
            </div>
        </div>
        <div class="ov-row">
            <div class="ov-item">
                <span class="ov-val text-primary" id="st-dist">0</span>
                <span class="ov-lbl">KM TOTALES</span>
            </div>
            <div class="ov-item">
                <span class="ov-val text-fire" id="st-cal">0</span>
                <span class="ov-lbl">KCAL</span>
            </div>
        </div>
        <!-- ELEVATION ROW (Only relevant for Hike/Bike) -->
        <div class="ov-row hidden" id="row-elev">
             <div class="ov-item full">
                <span class="ov-val" id="st-elev">0m</span>
                <span class="ov-lbl">DESNIVEL POSITIVO</span>
            </div>
        </div>
    </div>

    <!-- RECENT ACTIVITY LIST (Filtered) -->
    <h3 class="sub-title">HISTORIAL RECIENTE</h3>
    <div id="stats-history" class="history-list">
        <!-- JS Injected -->
    </div>
</div>

<script>
    import { trackingData } from '../stores/trainingStore';
    
    let allActivities = [];
    let currentFilter = 'all';

    const els = {
        count: document.getElementById('st-count'),
        time: document.getElementById('st-time'),
        dist: document.getElementById('st-dist'),
        cal: document.getElementById('st-cal'),
        elev: document.getElementById('st-elev'),
        rowElev: document.getElementById('row-elev'),
        history: document.getElementById('stats-history')
    };

    // UPDATE UI
    function renderStats() {
        // Flatten Data
        /* trackingData is map { "date": [objs] } */
        const raw = trackingData.get();
        allActivities = Object.entries(raw).flatMap(([date, list]) => 
            list.map(item => ({ ...item, date }))
        ).sort((a,b) => b.timestamp - a.timestamp);

        // Filter
        let filtered = allActivities;
        if(currentFilter !== 'all') {
            filtered = allActivities.filter(a => {
                let t = (a.activityType || '').toLowerCase();
                // Groups
                if(currentFilter === 'hiking' && ['trekking','cerro'].includes(t)) return true;
                if(currentFilter === 'gym' && ['hit','crossfit'].includes(t)) return true;
                return t === currentFilter;
            });
        }

        // Aggregate
        let totalCount = filtered.length;
        let totalTime = 0; // mins
        let totalDist = 0; // km
        let totalCal = 0;
        let totalElev = 0;

        filtered.forEach(a => {
            totalTime += (a.duration || 0);
            totalDist += (a.distance || 0);
            totalCal += (a.calories || 0);
            totalElev += (a.elevation || 0);
        });

        // Update DOM
        els.count.innerText = totalCount;
        els.time.innerText = `${Math.floor(totalTime/60)}h ${totalTime%60}m`;
        els.dist.innerText = totalDist.toFixed(1);
        els.cal.innerText = totalCal;
        els.elev.innerText = `${totalElev}m`;

        // Visibility of Elev
        if(['hiking', 'bike'].includes(currentFilter)) els.rowElev.classList.remove('hidden');
        else els.rowElev.classList.add('hidden');

        // Render History List
        els.history.innerHTML = '';
        filtered.slice(0, 10).forEach(act => {
             const div = document.createElement('div');
             div.className = 'hist-item';
             
             // Dynamic detail string
             let details = `${act.duration}min`;
             if(act.distance > 0) details += ` · ${act.distance}km`;
             if(act.calories > 0) details += ` · ${act.calories}kcal`;

             div.innerHTML = `
                <div class="h-left">
                    <span class="h-date">${formatDate(act.date)}</span>
                    <span class="h-title">${act.title}</span>
                </div>
                <div class="h-right">
                    ${details}
                </div>
             `;
             els.history.appendChild(div);
        });
    }

    function formatDate(iso) {
        const parts = iso.split('-');
        return `${parts[2]}/${parts[1]}`;
    }

    // TABS
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.getAttribute('data-filter');
            renderStats();
        };
    });

    // Sub to store
    trackingData.subscribe(() => {
        renderStats();
    });

</script>

<style>
    .stats-container { padding: 20px; padding-bottom: 80px; }
    .section-title { font-family: 'Russo One'; color: white; margin: 0 0 20px 0; font-size: 1.5rem; letter-spacing: 1px; }
    
    /* TABS */
    .tabs-scroll { 
        display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 20px; 
        scrollbar-width: none; 
    }
    .tabs-scroll::-webkit-scrollbar { display: none; }
    .tab-btn {
        background: #1e293b; color: #94a3b8; border: 1px solid #334155;
        padding: 8px 16px; border-radius: 20px; font-weight: 700; white-space: nowrap;
        font-size: 0.8rem; cursor: pointer; transition: 0.2s;
    }
    .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* OVERVIEW CARD */
    .overview-card {
        background: #1e293b; border-radius: 16px; padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px;
    }
    .ov-row { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .ov-row:last-child { margin-bottom: 0; }
    .ov-item { flex: 1; text-align: center; }
    .ov-item.full { width: 100%; border-top: 1px solid #334155; padding-top: 15px; }

    .ov-val { display: block; font-family: 'Russo One'; font-size: 1.8rem; line-height: 1; color: white; }
    .ov-lbl { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; margin-top: 5px; letter-spacing: 1px; }

    .text-primary { color: var(--primary); }
    .text-fire { color: #f59e0b; }

    /* HISTORY */
    .sub-title { font-family: 'Russo One'; font-size: 1rem; color: #94a3b8; margin-bottom: 15px; }
    .history-list { display: flex; flex-direction: column; gap: 10px; }
    .hist-item {
        background: #0f172a; border: 1px solid #334155; padding: 12px; border-radius: 8px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .h-left { display: flex; flex-direction: column; }
    .h-date { font-size: 0.7rem; color: var(--primary); font-weight: 700; }
    .h-title { font-size: 0.95rem; font-weight: 600; color: white; }
    .h-right { font-size: 0.8rem; color: #94a3b8; text-align: right; }
</style>
