<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Patagonia 2026</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#121212">

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&family=Russo+One&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23FF5722%22><path d=%22M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z%22/></svg>">

    <style>
        :root {
            --primary: #FF5722;
            --bg-main: #121212;
            --bg-card: #1E1E1E;
            --text-white: #ffffff;
            --text-gray: #90A4AE;
            --success: #76FF03;
            --font-head: 'Russo One', sans-serif;
            --font-body: 'Montserrat', sans-serif;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            background-color: var(--bg-main);
            color: var(--text-white);
            font-family: var(--font-body);
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* --- LANDING PAGE --- */
        #landing-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #263238 0%, #000000 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }

        #landing-page.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .logo-icon-lg {
            width: 90px;
            height: 90px;
            fill: var(--primary);
            margin-bottom: 25px;
            filter: drop-shadow(0 0 15px rgba(255, 87, 34, 0.6));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .landing-title {
            font-family: var(--font-head);
            font-size: 2.5rem;
            text-align: center;
            line-height: 1.1;
            margin-bottom: 40px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .landing-title span {
            color: var(--primary);
        }

        .start-btn {
            padding: 16px 50px;
            background: transparent;
            color: white;
            border: 2px solid var(--primary);
            font-family: var(--font-head);
            font-size: 1.2rem;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .start-btn:active {
            transform: scale(0.95);
            background: var(--primary);
        }

        /* --- MAIN APP --- */
        #app-container {
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        #app-container.visible {
            opacity: 1;
        }

        /* Sticky Header */
        .sticky-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(18, 18, 18, 0.98);
            border-bottom: 1px solid #333;
            padding: 15px 20px 10px 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
            padding-top: env(safe-area-inset-top, 15px);
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon-sm {
            width: 30px;
            height: 30px;
            fill: var(--primary);
        }

        .header-title h1 {
            font-family: var(--font-head);
            font-size: 1.1rem;
            margin: 0;
            line-height: 1;
            letter-spacing: 0.5px;
        }

        .header-title span {
            color: var(--primary);
        }

        .settings-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .settings-btn svg {
            width: 24px;
            height: 24px;
            fill: #555;
            transition: 0.3s;
        }

        .settings-btn:hover svg {
            fill: white;
            transform: rotate(90deg);
        }

        /* Stats HUD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .stat-card {
            background: #252525;
            padding: 8px 5px;
            border-radius: 6px;
            text-align: center;
            border-bottom: 2px solid var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card h3 {
            font-size: 0.55rem;
            color: #999;
            margin: 0 0 4px 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card p {
            font-family: var(--font-head);
            font-size: 1.1rem;
            margin: 0;
            color: white;
            line-height: 1;
        }

        /* --- NUEVO CONTROL PANEL (Fases + Dropdown) --- */
        .control-panel {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* Fases a la izq, Filtro a la der */
            gap: 10px;
            padding-top: 5px;
        }

        /* Fases (Scroll horizontal si es necesario) */
        .phases-bar {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .phase-btn {
            background: #333;
            color: #888;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.65rem;
            white-space: nowrap;
            transition: 0.2s;
        }

        .phase-btn.active {
            background: var(--primary);
            color: white;
        }

        /* --- DROPDOWN PERSONALIZADO --- */
        .filter-dropdown-container {
            position: relative;
            min-width: 140px;
            /* Ancho fijo para el bot√≥n */
        }

        .filter-trigger-btn {
            width: 100%;
            background: #252525;
            border: 1px solid #444;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.7rem;
            font-weight: 700;
            transition: 0.2s;
        }

        .filter-trigger-btn span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-trigger-btn svg {
            width: 14px;
            height: 14px;
            fill: var(--primary);
        }

        .filter-trigger-btn:active {
            transform: scale(0.98);
        }

        /* Men√∫ Oculto */
        .filter-menu {
            position: absolute;
            top: 110%;
            right: 0;
            width: 160px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #444;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 5px;
            display: none;
            /* Oculto por defecto */
            flex-direction: column;
            gap: 2px;
            z-index: 2000;
            animation: slideDownMenu 0.2s ease forwards;
        }

        @keyframes slideDownMenu {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-menu.show {
            display: flex;
        }

        .filter-option {
            background: transparent;
            border: none;
            color: #aaa;
            padding: 10px;
            text-align: left;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }

        .filter-option svg {
            width: 16px;
            height: 16px;
            fill: #666;
            transition: 0.2s;
        }

        .filter-option:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .filter-option:hover svg {
            fill: white;
        }

        .filter-option.selected {
            background: rgba(255, 87, 34, 0.15);
            color: var(--primary);
        }

        .filter-option.selected svg {
            fill: var(--primary);
        }

        /* --- SCROLL CONTENT --- */
        .scroll-content {
            padding-top: 230px;
            /* Ajustado para el nuevo header */
            padding-left: 15px;
            padding-right: 15px;
            padding-bottom: 80px;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* WEEKLY VIEW STYLES */
        .week-block {
            margin-bottom: 25px;
            background: #1a1a1a;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #333;
        }

        .week-block.current-week {
            border: 1px solid var(--primary);
            box-shadow: 0 0 15px rgba(255, 87, 34, 0.2);
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }

        .week-title {
            color: white;
            font-family: var(--font-head);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .week-dates {
            font-size: 0.75rem;
            color: #777;
            font-weight: 600;
        }

        .week-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            /* Desktop: 7 columns */
            gap: 5px;
        }

        @media (max-width: 600px) {
            .week-row {
                /* Mobile: Horizontal Scroll for days in the week */
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                /* Smooth iOS scroll */
                padding-bottom: 10px;
                scrollbar-width: none;
                gap: 10px;
                scroll-snap-type: x mandatory;
                /* Optional: Snap to cards */
            }

            .day-card {
                scroll-snap-align: start;
            }

            .week-row::-webkit-scrollbar {
                display: none;
            }

            .day-card {
                min-width: 100px;
                /* Fixed width for better touch targets */
                min-height: 110px;
            }

            .day-card .activity-name {
                display: block !important;
                font-size: 0.7rem;
            }

            .day-card .activity-icon {
                width: 32px;
                height: 32px;
            }
        }

        .day-header {
            text-align: center;
            font-size: 0.6rem;
            color: #555;
            font-weight: 800;
            padding-bottom: 5px;
        }

        .day-card {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 8px 4px;
            min-height: 85px;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            border: 1px solid transparent;
            transition: transform 0.2s;
        }

        .day-card:active {
            transform: scale(0.95);
        }

        .day-card.completed {
            border-color: var(--success);
            background: #1a2e1e;
        }

        .day-card.completed svg {
            fill: var(--success) !important;
        }

        .day-card.completed .activity-name {
            color: var(--success);
        }

        .day-card.has-note::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }

        .day-phase {
            position: absolute;
            top: 0;
            left: 0;
            font-size: 0.5rem;
            background: #333;
            color: #aaa;
            padding: 2px 4px;
            border-bottom-right-radius: 4px;
        }

        .day-date {
            font-size: 0.6rem;
            color: #555;
            font-weight: 700;
            align-self: flex-end;
            margin-right: 2px;
        }

        .activity-icon {
            width: 24px;
            height: 24px;
            fill: #607D8B;
            margin-top: 4px;
        }

        .activity-name {
            font-size: 0.6rem;
            text-align: center;
            color: white;
            line-height: 1.1;
            margin-bottom: 2px;
        }

        .day-card.empty {
            background: transparent;
            border: none;
            pointer-events: none;
        }

        .calendar-grid.filtered-mode .day-card {
            width: 90px;
        }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            border: 1px solid #444;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .modal-header h2 {
            color: var(--primary);
            margin: 0;
            font-family: var(--font-head);
            font-size: 1.3rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: #777;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .coach-note {
            background: #111;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
            margin-bottom: 20px;
        }

        .day-card.planned-only {
            opacity: 0.6;
            background-color: #fcfcfc;
            border: 1px dashed #ddd;
            /* Dotted border for plan */
        }

        .day-card.planned-only .activity-icon {
            fill: #ccc;
            /* Grey icon for plan */
        }

        .day-card.planned-only .activity-name {
            color: #999;
        }

        .journal-input {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-family: sans-serif;
            resize: vertical;
            min-height: 80px;
        }

        .action-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 6px;
            font-family: var(--font-head);
            font-size: 1rem;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn-complete {
            background: var(--success);
            color: #000;
        }

        .btn-undo {
            background: #333;
            color: #ccc;
        }

        /* FLEX LOGGING STYLES */
        .type-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 20px;
        }

        .type-btn {
            background: #252525;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px 5px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .type-btn svg {
            width: 20px;
            height: 20px;
            fill: #666;
            margin-bottom: 5px;
        }

        .type-btn span {
            font-size: 0.55rem;
            color: #666;
            font-weight: 700;
            text-transform: uppercase;
        }

        .type-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        .type-btn.active svg {
            fill: white;
        }

        .type-btn.active span {
            color: white;
        }

        .section-label {
            font-size: 0.7rem;
            color: var(--text-gray);
            margin: 15px 0 8px 0;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* SETTINGS MODAL */
        #settingsModal .settings-option {
            background: #222;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-small {
            background: var(--primary);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.8rem;
        }

        @media (max-width: 600px) {
            .scroll-content {
                padding-top: 240px;
                padding-left: 5px;
                padding-right: 5px;
            }

            .calendar-grid {
                grid-template-columns: repeat(7, minmax(35px, 1fr));
                gap: 3px;
            }

            .day-card {
                min-height: 55px;
                padding: 2px;
            }

            .activity-icon {
                width: 18px;
                height: 18px;
            }

            .activity-name {
                display: none;
            }

            .day-phase {
                display: none;
            }

            .calendar-grid.filtered-mode .day-card {
                width: 48%;
                min-height: 90px;
            }

            .calendar-grid.filtered-mode .activity-name {
                display: block;
            }

            .landing-title {
                font-size: 2.2rem;
            }

            /* header elements */
            .main-header {
                margin-bottom: 5px;
            }

            .dashboard-grid {
                margin-bottom: 5px;
            }
        }
    </style>
</head>

<body>
    <!-- LOGIN OVERLAY -->
    <div id="login-overlay"
        style="display:flex; position:fixed; top:0; left:0; width:100%; height:100%; z-index:99999; background: #0f172a; align-items:center; justify-content:center; flex-direction:column;">
        <div class="glass-card"
            style="padding:40px; border-radius:24px; text-align:center; max-width:90%; width:350px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px);">
            <div style="margin-bottom:20px; font-size:3rem;">üèîÔ∏è</div>
            <h1 style="color:white; font-family:var(--font-head); font-size:1.8rem; margin-bottom:5px;">PATAGONIA</h1>
            <p style="color:#888; font-size:0.8rem; margin-bottom:30px; letter-spacing:1px;">TRACKER LOGIN</p>

            <form style="display:flex; flex-direction:column; gap:15px;">
                <input type="email" id="login-email" placeholder="Email"
                    style="padding:15px; border-radius:12px; border:1px solid #333; background:rgba(0,0,0,0.3); color:white; outline:none;"
                    value="danielaranadj@gmail.com">
                <input type="password" id="login-pass" placeholder="Contrase√±a"
                    style="padding:15px; border-radius:12px; border:1px solid #333; background:rgba(0,0,0,0.3); color:white; outline:none;">
                <button type="submit" id="login-btn"
                    style="padding:15px; border-radius:12px; background:linear-gradient(135deg, #FF5722, #FF9100); color:white; font-weight:800; border:none; cursor:pointer;">INGRESAR</button>
            </form>
            <p id="login-error" style="color:#ff5252; font-size:0.8rem; margin-top:15px; display:none;"></p>
        </div>
    </div>

    <div style="display: none;">
        <svg id="icon-cerro" viewBox="0 0 24 24">
            <path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z" />
        </svg>
        <svg id="icon-gym" viewBox="0 0 24 24">
            <path
                d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 5.57 2 7.71 3.43 9.14 2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 16.29 22 18.43 19.86 19.86 18.43 22 16.29z" />
        </svg>
        <svg id="icon-cardio" viewBox="0 0 24 24">
            <path
                d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7" />
        </svg>
        <svg id="icon-rest" viewBox="0 0 24 24">
            <path
                d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
        </svg>
        <svg id="icon-filter" viewBox="0 0 24 24">
            <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
        </svg>
    </div>

    <div id="landing-page">
        <svg class="logo-icon-lg" viewBox="0 0 24 24">
            <path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z" />
        </svg>
        <div class="landing-title">PATAGONIA<br><span>TREKKING 2026</span></div>
        <button class="start-btn" onclick="enterApp()">INGRESAR</button>
    </div>

    <div id="app-container">
        <div class="sticky-wrapper">
            <div class="main-header">
                <div class="header-brand">
                    <svg class="logo-icon-sm" viewBox="0 0 24 24">
                        <path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z" />
                    </svg>
                    <div class="header-title">
                        <h1>PATAGONIA <span>TREKKING</span></h1>
                    </div>
                </div>
                <button class="settings-btn" onclick="openSettings()">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z" />
                    </svg>
                </button>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>D√çAS RESTANTES</h3>
                    <p id="daysLeft">...</p>
                </div>
                <div class="stat-card">
                    <h3>ENTRENOS COMPLETOS</h3>
                    <p id="completedCount">0</p>
                </div>
                <div class="stat-card">
                    <h3>FASE ACTUAL</h3>
                    <p id="currentPhaseLabel" style="font-size: 0.9rem; line-height: 1.1rem; color: var(--primary)">...
                    </p>
                </div>
            </div>

            <div class="control-panel">
                <div class="phases-bar">
                    <button class="phase-btn active" onclick="setPhaseFilter('all', this)">VER TODO</button>
                    <button class="phase-btn" onclick="setPhaseFilter(1, this)">FASE 1</button>
                    <button class="phase-btn" onclick="setPhaseFilter(2, this)">FASE 2</button>
                    <button class="phase-btn" onclick="setPhaseFilter(3, this)">FASE 3</button>
                    <button class="phase-btn"
                        style="color:var(--primary); font-weight:800; border:1px solid var(--primary);"
                        onclick="toggleStats()">GR√ÅFICAS</button>
                </div>

                <div class="filter-dropdown-container">
                    <button class="filter-trigger-btn" onclick="toggleFilterMenu()">
                        <span id="filterLabel">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
                            </svg>
                            TODOS
                        </span>
                        <span>‚ñº</span>
                    </button>
                    <div id="filterMenu" class="filter-menu">
                        <button class="filter-option selected" onclick="setTypeFilter('all', this, 'TODOS')">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
                            </svg> TODOS
                        </button>
                        <button class="filter-option" onclick="setTypeFilter('walk', this, 'WALK')">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7" />
                            </svg> WALK
                        </button>
                        <button class="filter-option" onclick="setTypeFilter('running', this, 'RUNNING')">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7" />
                            </svg> RUNNING
                        </button>
                        <button class="filter-option" onclick="setTypeFilter('hiking', this, 'HIKING')">
                            <svg viewBox="0 0 24 24">
                                <path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z" />
                            </svg> HIKING
                        </button>
                        <button class="filter-option" onclick="setTypeFilter('trekking', this, 'TREKKING')">
                            <svg viewBox="0 0 24 24">
                                <path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z" />
                            </svg> TREKKING
                        </button>
                        <button class="filter-option" onclick="setTypeFilter('hit', this, 'HIT')">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 5.57 2 7.71 3.43 9.14 2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 16.29 22 18.43 19.86 19.86 18.43 22 16.29z" />
                            </svg> HIT
                        </button>
                        <button class="filter-option" onclick="setTypeFilter('dayoff', this, 'DAYOFF')">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                            </svg> DAYOFF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="scroll-content">
            <div id="main-container"></div>

            <!-- STATS CONTAINER (Hidden by default) -->
            <div id="stats-container" style="display:none; padding-bottom:100px;">
                <h2 class="month-header" style="border-left:none; text-align:center; margin-bottom:20px;">CENTRO DE
                    OPERACIONES</h2>

                <!-- KPI CARDS -->
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-bottom:30px;">
                    <div class="week-block" style="text-align:center; padding:15px 5px;">
                        <div style="font-size:1.5rem; font-weight:800; color:var(--primary);" id="statTotalHours">0
                        </div>
                        <div style="font-size:0.6rem; color:#888;">HORAS TOTALES</div>
                    </div>
                    <div class="week-block" style="text-align:center; padding:15px 5px;">
                        <div style="font-size:1.5rem; font-weight:800; color:#76FF03;" id="statTotalCals">0</div>
                        <div style="font-size:0.6rem; color:#888;">KCAL QUEMADAS</div>
                    </div>
                    <div class="week-block" style="text-align:center; padding:15px 5px;">
                        <div style="font-size:1.5rem; font-weight:800; color:#FFC107;" id="statTotalActivities">0</div>
                        <div style="font-size:0.6rem; color:#888;">SESIONES</div>
                    </div>
                </div>

                <!-- CHARTS -->
                <div class="week-block">
                    <div class="week-header" style="border:none;">
                        <div class="week-title">DISTRIBUCI√ìN DE ACTIVIDAD</div>
                    </div>
                    <div style="height:250px; position:relative;">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>

                <div class="week-block">
                    <div class="week-header" style="border:none;">
                        <div class="week-title">VOLUMEN SEMANAL (MINUTOS)</div>
                    </div>
                    <div style="height:250px; position:relative;">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>

                <button class="action-btn" onclick="toggleStats()" style="background:#333; margin-top:20px;">VOLVER AL
                    CALENDARIO</button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalDate">FECHA</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div style="margin-bottom: 20px;">
                <!-- ACTIVITY TYPE -->
                <div class="section-label">TIPO DE ENTRENAMIENTO</div>
                <div class="type-selector" id="typeSelector" style="grid-template-columns: repeat(3, 1fr);">
                    <button class="type-btn" onclick="selectType('walk', this)">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7" />
                        </svg>
                        <span>WALK</span>
                    </button>
                    <button class="type-btn" onclick="selectType('running', this)">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7" />
                        </svg>
                        <span>RUNNING</span>
                    </button>
                    <button class="type-btn" onclick="selectType('hiking', this)">
                        <svg viewBox="0 0 24 24">
                            <path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z" />
                        </svg>
                        <span>HIKING</span>
                    </button>
                    <button class="type-btn" onclick="selectType('trekking', this)">
                        <svg viewBox="0 0 24 24">
                            <path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z" />
                        </svg>
                        <span>TREKKING</span>
                    </button>
                    <button class="type-btn" onclick="selectType('hit', this)">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 5.57 2 7.71 3.43 9.14 2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 16.29 22 18.43 19.86 19.86 18.43 22 16.29z" />
                        </svg>
                        <span>HIT</span>
                    </button>
                    <button class="type-btn" onclick="selectType('dayoff', this)">
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                        </svg>
                        <span>DAYOFF</span>
                    </button>
                </div>

            </div>

            <h3 id="modalTitle" style="color: white; margin-bottom: 5px; font-size:1.1rem;">ACTIVIDAD</h3>
            <input type="text" id="customTitleInput" class="journal-input"
                style="min-height:40px; margin-bottom:10px; padding:8px;" placeholder="T√≠tulo (Original: ...)">

            <div class="coach-note" id="coachSection">
                <small style="color:var(--primary); font-weight:bold;">PLAN ORIGINAL:</small>
                <p id="modalDescription" style="color: #aaa; margin:5px 0 0 0; font-size: 0.85rem;">...</p>
                <p id="modalNote" style="margin:5px 0 0 0; color:#ddd; font-style:italic; font-size: 0.8rem;">...
                </p>
            </div>

            <div class="section-label">DETALLES Y NOTAS</div>

            <!-- DATA FIELDS -->
            <div class="data-grid" id="dataFields"
                style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <div>
                    <label style="color:#777; font-size:0.7rem; font-weight:bold;">DURACI√ìN (MIN)</label>
                    <input type="number" id="durationInput" class="journal-input" placeholder="0"
                        style="margin-top:5px; text-align:center;">
                </div>
                <div>
                    <label style="color:#777; font-size:0.7rem; font-weight:bold;">CALOR√çAS (KCAL)</label>
                    <input type="number" id="caloriesInput" class="journal-input" placeholder="0"
                        style="margin-top:5px; text-align:center;">
                </div>
                <div id="distanceField">
                    <label style="color:#777; font-size:0.7rem; font-weight:bold;">DISTANCIA (KM)</label>
                    <input type="number" id="distanceInput" class="journal-input" placeholder="0.0" step="0.1"
                        style="margin-top:5px; text-align:center;">
                </div>
                <div id="elevationField">
                    <label style="color:#777; font-size:0.7rem; font-weight:bold;">ALTITUD (M)</label>
                    <input type="number" id="elevationInput" class="journal-input" placeholder="0"
                        style="margin-top:5px; text-align:center;">
                </div>
            </div>

            <textarea id="journalInput" class="journal-input"
                placeholder="¬øC√≥mo te sentiste? ¬øDistancia/Tiempo?"></textarea>

            <div class="section-label">NUTRICI√ìN üçé</div>
            <textarea id="mealsInput" class="journal-input" placeholder="Desayuno, Comida, Cena..." rows="2"
                style="min-height:60px;"></textarea>
        </div>

        <div style="display:flex; gap:10px;">
            <button id="deleteBtn" class="action-btn" style="background-color: #D32F2F; display:none;"
                onclick="deleteActivity()">ELIMINAR</button>
            <button id="completeBtn" class="action-btn btn-complete" style="flex:1;" onclick="saveActivity()">GUARDAR
                ACTIVIDAD</button>
        </div>
    </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>AJUSTES</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>
            <div class="settings-option">
                <div>
                    <h4>Exportar Datos</h4>
                </div>
                <button class="btn-small" onclick="exportData()">GUARDAR</button>
            </div>
            <div class="settings-option">
                <div>
                    <h4>Importar Datos</h4>
                </div>
                <button class="btn-small" onclick="document.getElementById('fileInput').click()">CARGAR</button>
                <input type="file" id="fileInput" accept=".json" onchange="importData(this)" style="display:none">
            </div>
        </div>
    </div>

    <script type="module">
        // Adjust START DATE to reset counter.
        // User wants Week 1 to be Jan 19-25.
        const startDate = new Date(2026, 0, 19); // Monday Jan 19, 2026
        const tripDate = new Date(2026, 10, 1);

        let trackingData = JSON.parse(localStorage.getItem('patagoniaFinal_v6')) || {};
        let filterPhase = 'all';
        let filterType = 'all';
        let selectedDateId = null;

        const phases = [
            { id: 1, name: "FASE 1: BASE", endMonth: 2 },
            { id: 2, name: "FASE 2: FUERZA", endMonth: 6 },
            { id: 3, name: "FASE 3: RESIST", endMonth: 9 },
            { id: 4, name: "TAPERING", endMonth: 10 }
        ];

        const routines = {
            1: { title: "Relax / Yoga", type: "dayoff", icon: "icon-rest", desc: "Estiramiento o caminata suave.", note: "Recuperaci√≥n activa." },
            2: { title: "Cardio Z2", type: "running", icon: "icon-cardio", desc: "40 min trote suave.", note: "Base aer√≥bica." },
            3: { title: "Gym Pierna", type: "hit", icon: "icon-gym", desc: "Sentadillas y Lunges.", note: "Piensa en el Fitz Roy." },
            4: { title: "Intervalos", type: "running", icon: "icon-cardio", desc: "30 min cambios de ritmo.", note: "Ganando aire." },
            5: { title: "Descanso Total", type: "dayoff", icon: "icon-rest", desc: "Dormir bien y comer.", note: "El m√∫sculo crece hoy." },
            6: { title: "D√≠a de Cerro", type: "hiking", icon: "icon-cerro", desc: "Salida a ruta.", note: "Conexi√≥n total." },
            0: { title: "Cerro / Relax", type: "hiking", icon: "icon-cerro", desc: "Opci√≥n B de monta√±a.", note: "Disfruta." }
        };

        function enterApp() {
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('app-container').classList.add('visible');
        }

        // --- FIREBASE CONFIG & AUTH ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdsu65Voj8en9u_7eL5q0YRFuCC7fUYWA",
            authDomain: "instantetrips-editor.firebaseapp.com",
            projectId: "instantetrips-editor",
            storageBucket: "instantetrips-editor.firebasestorage.app",
            messagingSenderId: "281917140804",
            appId: "1:281917140804:web:ed712e65c9c4b77dd3b111"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- LOGIN LOGIC ---
        const loginOverlay = document.getElementById('login-overlay');
        const appContainer = document.getElementById('app-container'); // Wrap main content in this if needed, or just toggle body.

        // We need to wrap the existing body content in a div to hide/show it, OR handle it via overlay z-index.
        // The admin used a full screen overlay. We'll do the same.

        // Listen to Auth State
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').style.display = 'none';
                console.log("Logged in:", user.email);

                // LOAD DATA FROM FIRESTORE
                await loadFromFirestore();

                renderCalendar();
                updateStats();
            } else {
                currentUser = null;
                document.getElementById('login-overlay').style.display = 'flex';
            }
        });

        // Login Form Handler
        document.getElementById('login-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const errorMsg = document.getElementById('login-error');

            try {
                btnLoading(true);
                await signInWithEmailAndPassword(auth, email, pass);
                // Auth Observer will handle success
            } catch (err) {
                btnLoading(false);
                errorMsg.textContent = "Error: " + err.message;
                errorMsg.style.display = 'block';
            }
        });

        function btnLoading(isLoading) {
            const btn = document.getElementById('login-btn');
            if (isLoading) {
                btn.innerHTML = 'Conectando...';
                btn.disabled = true;
            } else {
                btn.innerHTML = 'INGRESAR';
                btn.disabled = false;
            }
        }

        // --- FIRESTORE SYNC ---
        async function loadFromFirestore() {
            if (!currentUser) return;
            try {
                const docRef = doc(db, "users", currentUser.uid, "trekking", "data");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    console.log("Document data found in Cloud!");
                    trackingData = docSnap.data().trackingData || {};
                    // Merge/Update LocalStorage to keep them in sync?
                    localStorage.setItem('patagoniaFinal_v6', JSON.stringify(trackingData));
                } else {
                    console.log("No cloud data. Keeping LocalStorage.");
                    // Optional: Upload LocalStorage to Cloud now?
                    saveToFirestore();
                }
            } catch (e) {
                console.error("Error loading from cloud:", e);
                alert("Error cargando datos de la nube. Se usar√° copia local.");
            }
        }

        async function saveToFirestore() {
            if (!currentUser) return;
            // Debounce or immediate? Immediate for now via saveActivity.
            try {
                await setDoc(doc(db, "users", currentUser.uid, "trekking", "data"), {
                    trackingData: trackingData,
                    lastUpdate: new Date().toISOString()
                });
                console.log("Cloud Saved.");
            } catch (e) {
                console.error("Error saving to cloud:", e);
            }
        }

        // EXPORT functions for saveActivity to call
        window.saveToFirestore = saveToFirestore;

        // Auto-run (Removed, handled by onAuthStateChanged)
        // (function () {
        //     renderCalendar();
        //     updateStats();
        // })();

        let showingStats = false;
        let chartInstances = {};

        function toggleStats() {
            showingStats = !showingStats;
            const main = document.getElementById('main-container');
            const stats = document.getElementById('stats-container');
            const filterRow = document.querySelector('.controls-row');

            if (showingStats) {
                main.style.display = 'none';
                stats.style.display = 'block';
                // Hide filters while in stats
                if (filterRow) filterRow.style.display = 'none';
                renderCharts();
            } else {
                main.style.display = 'block';
                stats.style.display = 'none';
                if (filterRow) filterRow.style.display = 'flex';
            }
        }

        function renderCharts() {
            // 1. Calculate Data
            let totalMins = 0;
            let totalCals = 0;
            let typeCounts = { 'cardio': 0, 'gym': 0, 'cerro': 0, 'swim': 0, 'rest': 0 };

            // Weekly Data for Volume Chart (group by week start)
            // Simplified: just show last 8 weeks or all? Let's show all weeks that have data.
            let weeklyVolume = {};

            Object.keys(trackingData).forEach(dateStr => {
                let entries = trackingData[dateStr];
                // Flatten to array
                if (!Array.isArray(entries)) entries = [entries];

                entries.forEach(entry => {
                    if (entry.completed) {
                        const dur = entry.duration || 0;
                        totalMins += dur;
                        totalCals += (entry.calories || 0);

                        let type = entry.activityType || 'cardio';
                        if (typeCounts[type] !== undefined) typeCounts[type]++;
                        else typeCounts['cardio']++; // fallback

                        // Volume per week
                        // Need date from file KEY, not specific entry param
                        const d = new Date(dateStr);
                        const oneJan = new Date(d.getFullYear(), 0, 1);
                        const numberOfDays = Math.floor((d - oneJan) / (24 * 60 * 60 * 1000));
                        const weekNum = Math.ceil((d.getDay() + 1 + numberOfDays) / 7);

                        const label = `Sem ${weekNum}`;
                        if (!volumeData[label]) volumeData[label] = 0;
                        volumeData[label] += dur;
                    }
                });
            });

            // Update KPI Cards
            document.getElementById('statTotalHours').innerText = (totalMins / 60).toFixed(1);
            document.getElementById('statTotalCals').innerText = totalCals.toLocaleString();

            // Stats Activities Count (Unique Days or Total Sessions?)
            // Usually Stats = Total Sessions (Work Done). Compliance = Days.
            // Let's count Total Sessions here.
            let totalSessions = 0;
            Object.values(trackingData).forEach(v => {
                if (Array.isArray(v)) totalSessions += v.length;
                else if (v && v.completed) totalSessions++;
            });
            document.getElementById('statTotalActivities').innerText = totalSessions;

            const weekLabels = Object.keys(volumeData).sort(); // simple string sort for now
            const weekValues = weekLabels.map(l => volumeData[l]);

            const ctxVol = document.getElementById('volumeChart').getContext('2d');
            chartInstances.volume = new Chart(ctxVol, {
                type: 'bar',
                data: {
                    labels: weekLabels.length > 0 ? weekLabels : ['Sin Datos'],
                    datasets: [{
                        label: 'Minutos',
                        data: weekValues.length > 0 ? weekValues : [0],
                        backgroundColor: '#FF5722',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // --- DROPDOWN LOGIC ---
        function toggleFilterMenu() {
            document.getElementById('filterMenu').classList.toggle('show');
        }

        // Cierra el men√∫ si haces clic fuera
        window.onclick = function (event) {
            if (!event.target.matches('.filter-trigger-btn') && !event.target.closest('.filter-trigger-btn')) {
                var dropdowns = document.getElementsByClassName("filter-menu");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function getPhase(date) {
            const month = date.getMonth();
            if (month <= 2) return phases[0];
            if (month <= 6) return phases[1];
            if (month <= 9) return phases[2];
            return phases[3];
        }

        function renderCalendar() {
            const container = document.getElementById('main-container');
            container.innerHTML = '';

            // 1. Calculate General Progress Stats
            const today = new Date();
            const timeDiff = tripDate.getTime() - startDate.getTime();
            const totalPlanDays = Math.ceil(timeDiff / (1000 * 3600 * 24)); // Total days in plan

            // Calculate Remaining Days from Today
            let daysRemaining = Math.ceil((tripDate.getTime() - today.getTime()) / (1000 * 3600 * 24));
            if (daysRemaining < 0) daysRemaining = 0;

            // Calculate Completed (Count Days with > 0 activities)
            let totalCompleted = 0;
            Object.values(trackingData).forEach(val => {
                if (Array.isArray(val) && val.length > 0) totalCompleted++;
                else if (val && val.completed) totalCompleted++; // Fallback for old object
            });

            // Progress Percentage (Completed / Total DAYS)
            // Or should it be Completed / (Days Passed)? 
            // User said: "if all completed at the end = 100%". So Denominator = TotalPlanDays.
            let progressPercent = (totalCompleted / totalPlanDays) * 100;
            if (progressPercent > 100) progressPercent = 100;

            // HTML for Compliance Chart
            const complianceHtml = `
                <div class="compliance-card" style="background:#fff; border-radius:8px; padding:15px; margin-bottom:20px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:10px;">
                        <div>
                            <div style="font-size:0.75rem; color:#777; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;">PROGRESO GENERAL</div>
                            <div style="font-size:1.8rem; font-weight:800; color:var(--primary); line-height:1;">${progressPercent.toFixed(1)}%</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.9rem; font-weight:700; color:#333;">${totalCompleted} / ${totalPlanDays}</div>
                            <div style="font-size:0.7rem; color:#888;">Complete ‚Ä¢ ${daysRemaining} D√≠as Restantes</div>
                        </div>
                    </div>
                    <div style="width:100%; height:8px; background:#eee; border-radius:4px; overflow:hidden;">
                        <div style="width:${progressPercent}%; height:100%; background:var(--primary);"></div>
                    </div>
                </div>
            `;

            // Inject header
            container.innerHTML = complianceHtml;

            // Calculate start date (Monday of the start week)
            let currentDate = new Date(startDate);
            let weekCount = 1;

            // Generate weeks
            while (currentDate <= tripDate) {
                const weekEnd = new Date(currentDate);
                weekEnd.setDate(currentDate.getDate() + 6);

                const phase = getPhase(currentDate);

                // Create Week Block
                const weekBlock = document.createElement('div');
                weekBlock.className = 'week-block';

                // Highlight Target Week (Jan 19-25 or Today)
                const today = new Date();
                const isTargetWeek = (currentDate.getDate() === 19 && currentDate.getMonth() === 0 && currentDate.getFullYear() === 2026) ||
                    (today >= currentDate && today <= weekEnd);

                if (isTargetWeek) {
                    weekBlock.classList.add('current-week');
                    weekBlock.id = 'target-week-scroll';
                }

                const startStr = currentDate.getDate();
                const endStr = weekEnd.getDate();
                const monthName = currentDate.toLocaleDateString('es-MX', { month: 'short' }).toUpperCase();

                // MOTIVATIONAL QUOTES
                const quotes = [
                    "El dolor es temporal, la gloria es eterna.",
                    "No pares cuando duela, para cuando termines.",
                    "Tu √∫nica competencia es quien eras ayer.",
                    "Cada paso cuenta, cada metro suma.",
                    "La monta√±a no se conquista, te conquistas a ti mismo.",
                    "Entrena hoy para disfrutar ma√±ana.",
                    "La disciplina es el puente entre metas y logros.",
                    "Si fuera f√°cil, todos lo har√≠an.",
                    "Suda ahora, brilla despu√©s.",
                    "Tu cuerpo puede aguantar casi todo. Es tu mente a la que tienes que convencer.",
                    "No cuentes los d√≠as, haz que los d√≠as cuenten.",
                    "El √©xito es la suma de peque√±os esfuerzos repetidos d√≠a tras d√≠a.",
                    "Cae siete veces, lev√°ntate ocho.",
                    "La vista es mejor desde la cima.",
                    "No te detengas hasta que te sientas orgulloso.",
                    "La fatiga se va, el orgullo se queda.",
                    "Hazlo con pasi√≥n o no lo hagas.",
                    "Lo √∫nico imposible es aquello que no intentas.",
                    "Supera tus l√≠mites, no tus excusas.",
                    "Hoy es un buen d√≠a para ser m√°s fuerte.",
                    "El sacrificio de hoy es el √©xito de ma√±ana.",
                    "Cree en ti y todo ser√° posible.",
                    "La constancia vence al talento.",
                    "No bajes la meta, aumenta el esfuerzo.",
                    "Eres m√°s fuerte de lo que crees.",
                    "Respira hondo y sigue adelante.",
                    "El camino es duro, pero la recompensa es enorme.",
                    "Transforma el 'no puedo' en 'ya lo hice'.",
                    "Tu actitud determina tu altitud.",
                    "Cada gota de sudor es un paso hacia la cima.",
                    "Enf√≥cate en la meta, no en el dolor.",
                    "La resistencia se construye paso a paso.",
                    "S√© la mejor versi√≥n de ti mismo.",
                    "No sue√±es con el √©xito, trabaja por √©l.",
                    "La monta√±a te espera, prep√°rate.",
                    "El verdadero fracaso es no intentarlo.",
                    "Desaf√≠ate a ti mismo cada d√≠a.",
                    "La fuerza de voluntad es un m√∫sculo, entr√©nalo.",
                    "Da siempre tu 100%.",
                    "No busques excusas, busca resultados.",
                    "El dolor de hoy es la fuerza de ma√±ana.",
                    "Nunca te rindas, grandes cosas llevan tiempo.",
                    "Mant√©n la vista en la cima."
                ];

                let weekQuote = quotes[(weekCount - 1) % quotes.length];

                // Logic for Final Week (Approx Nov 1st)
                // If weekEnd includes Nov 1, 2026
                if (weekEnd >= tripDate) {
                    weekQuote = "‚ú® ¬°LO LOGRASTE! LA PATAGONIA ES TUYA. ‚ú®";
                }

                weekBlock.innerHTML = `
                    <div class="week-header" style="padding-bottom:10px;">
                        <div class="week-title-row" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:5px;">
                            <div class="week-title" style="white-space:nowrap; flex-shrink:0;">SEMANA ${weekCount} <span style="color:var(--primary)">//</span> FASE ${phase.id}</div>
                            <div class="week-dates" style="font-size:0.8rem; color:#666;">${startStr} - ${endStr} ${monthName}</div>
                        </div>
                        <div class="week-quote" style="font-size:0.8rem; color:#aaa; font-style:italic; margin-top:4px; line-height:1.2; padding-right:10px;">"${weekQuote}"</div>
                    </div>
                `;

                const weekRow = document.createElement('div');
                weekRow.className = 'week-row';

                // Render 7 Days
                for (let i = 0; i < 7; i++) {
                    const dayOfWeek = currentDate.getDay(); // 0-6
                    const routine = routines[dayOfWeek];
                    const dateId = currentDate.toISOString().split('T')[0];
                    const entry = trackingData[dateId];

                    // Filter Logic
                    let showCard = true;
                    if (filterPhase !== 'all' && phase.id != filterPhase) showCard = false;
                    // If filtering by type, only show if entry exists AND matches type
                    if (filterType !== 'all') {
                        if (!entry) showCard = false; // Empty days don't have types
                        else if (entry.activityType !== filterType) showCard = false;
                    }

                    if (showCard) {
                        const card = document.createElement('div');
                        card.className = 'day-card';
                        if (entry && entry.completed) card.classList.add('completed');
                        if (entry && (entry.note || entry.meals)) card.classList.add('has-note');

                        // Closure params
                        const dIndex = dayOfWeek;
                        const pId = phase;
                        const rData = routine;
                        const dId = dateId;

                        card.onclick = () => openModal(dId, dIndex, pId, routine); // Pass routine back

                        let iconId = 'icon-filter';
                        let displayTitle = routine.title;
                        let svgHtml = '';

                        // Handle Entry Array vs Single Object
                        let primaryEntry = null;
                        if (entry) {
                            if (Array.isArray(entry) && entry.length > 0) primaryEntry = entry[0];
                            else if (!Array.isArray(entry) && entry.completed) primaryEntry = entry;
                        }

                        // Determine Display Type
                        const displayType = (primaryEntry && primaryEntry.activityType) ? primaryEntry.activityType : routine.type;

                        // Map Icons
                        if (displayType === 'gym' || displayType === 'hit') iconId = 'icon-gym';
                        else if (displayType === 'rest' || displayType === 'dayoff') iconId = 'icon-rest';
                        else if (displayType === 'cerro' || displayType === 'hike' || displayType === 'hiking' || displayType === 'trekking') iconId = 'icon-cerro';
                        else if (displayType === 'swim') iconId = 'icon-rest';
                        else iconId = 'icon-cardio';

                        const iconEl = document.getElementById(iconId);
                        if (iconEl) svgHtml = iconEl.innerHTML;

                        if (primaryEntry) {
                            displayTitle = primaryEntry.title || routine.title;
                        }

                        // Show "Multiple" indicator?
                        let extraHtml = '';
                        if (Array.isArray(entry) && entry.length > 1) {
                            extraHtml = `<span style="position:absolute; top:2px; right:2px; background:var(--primary); color:white; font-size:9px; width:14px; height:14px; border-radius:50%; display:flex; align-items:center; justify-content:center;">+${entry.length - 1}</span>`;
                        }

                        if (!entry || (Array.isArray(entry) && entry.length === 0)) {
                            card.classList.add('planned-only');
                        }

                        const mealIndicator = (primaryEntry && primaryEntry.meals) ? 'üçé' : '';
                        const dayName = currentDate.toLocaleDateString('es-MX', { weekday: 'short' }).toUpperCase();

                        card.innerHTML = `
                            ${extraHtml}
                            <div class="day-phase" style="right:0; left:auto; border-radius:0 0 0 4px;">${dayName}</div>
                            <div class="day-date">${currentDate.getDate()}</div>
                            <svg class="activity-icon" viewBox="0 0 24 24">${svgHtml}</svg>
                            <div class="activity-name">${displayTitle} ${mealIndicator}</div>
                        `;
                        weekRow.appendChild(card);
                    }

                    // Advance Day
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (weekRow.children.length > 0) {
                    weekBlock.appendChild(weekRow);
                    container.appendChild(weekBlock);
                }

                weekCount++;
            }

            // Scroll to Target
            setTimeout(() => {
                const target = document.getElementById('target-week-scroll');
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 600);
        }



        function setPhaseFilter(val, btn) {
            filterPhase = val;
            document.querySelectorAll('.phase-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCalendar();
        }

        function setTypeFilter(val, btnElement, label) {
            filterType = val;

            // Actualizar Label del Dropdown
            const iconSvg = btnElement.querySelector('svg').outerHTML;
            document.getElementById('filterLabel').innerHTML = iconSvg + " " + label;

            // Actualizar estado visual del men√∫
            document.querySelectorAll('.filter-option').forEach(b => b.classList.remove('selected'));
            btnElement.classList.add('selected');

            renderCalendar();
        }

        let currentSelectedType = 'cardio';

        function selectType(type, btn) {
            currentSelectedType = type;
            document.querySelectorAll('#typeSelector .type-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // Toggle Data Fields based on Type
            const dataFields = document.getElementById('dataFields');
            const distField = document.getElementById('distanceField');
            const elevField = document.getElementById('elevationField');

            // Reset visibility
            dataFields.style.opacity = '1';
            dataFields.style.pointerEvents = 'auto';
            if (distField) distField.style.display = 'block';
            if (elevField) elevField.style.display = 'block';

            if (type === 'dayoff') {
                dataFields.style.opacity = '0.3';
                dataFields.style.pointerEvents = 'none';
            } else if (type === 'hit') {
                // HIT: Time, Cals only
                if (distField) distField.style.display = 'none';
                if (elevField) elevField.style.display = 'none';
            } else if (type === 'walk' || type === 'running') {
                // Walk/Run: Dist, Time, Cals (No Elev)
                if (elevField) elevField.style.display = 'none';
            } else {
                // Hike/Trek: All fields
            }
        }

        // GLOBAL for Modal Logic
        let currentActivityIndex = 0; // 0, 1, 2...
        // For multi-activity, trackingData[date] will be an ARRAY of objects.
        // Old data (Object) will be migrated on the fly or just handled.

        function openModal(dateStr, dayOfWeek, phase, routine) {
            selectedDateId = dateStr;
            let entry = trackingData[dateStr];

            // 1. MIGRATION: Ensure Array
            if (entry && !Array.isArray(entry)) {
                entry = [entry];
                trackingData[dateStr] = entry; // Persist migration
            }
            if (!entry) entry = []; // Empty array if no data

            document.getElementById('modal').style.display = 'flex';

            const parts = dateStr.split('-');
            const d = new Date(parts[0], parts[1] - 1, parts[2]);

            document.getElementById('modalDate').innerText = d.toLocaleDateString('es-MX', { weekday: 'long', day: 'numeric', month: 'long' }).toUpperCase();

            // RENDER TABS
            renderActivityTabs(entry);

            // Select Default (Last one or 0)
            // If empty, we are in "New" mode at index 0 (virtual)
            if (entry.length === 0) {
                currentActivityIndex = -1; // -1 means NEW
                loadFormEmpty(routine);
            } else {
                currentActivityIndex = 0; // Select first by default
                loadFormFromEntry(entry[0]);
            }
        }

        function renderActivityTabs(entryArray) {
            const container = document.getElementById('coachSection'); // Using this space for Tabs now
            // Or create a new container above inputs? Let's use coachSection as the container wrapper

            let html = `<div style="display:flex; gap:10px; margin-bottom:10px; overflow-x:auto;">`;

            // Existing entries
            entryArray.forEach((e, idx) => {
                const activeStyle = (idx === currentActivityIndex) ? 'border:1px solid var(--primary); color:white;' : 'border:1px solid #444; color:#777;';
                html += `<button onclick="switchTab(${idx})" style="padding:5px 10px; background:#222; border-radius:4px; font-size:0.8rem; cursor:pointer; ${activeStyle}">${e.title || 'Actividad'}</button>`;
            });

            // Add New Button
            const addStyle = (currentActivityIndex === -1) ? 'border:1px solid var(--primary); color:white;' : 'border:1px solid #444; color:#777;';
            html += `<button onclick="switchTab(-1)" style="padding:5px 10px; background:#222; border-radius:4px; font-size:0.8rem; cursor:pointer; ${addStyle}">+ A√ëADIR</button>`;

            html += `</div>`;

            // Add Phase Info below tabs
            // html += `<small style="display:block; color:#666; font-size:0.7rem;">Fase: ${document.getElementById('modalDescription').innerText}</small>`;

            container.innerHTML = html;
        }

        function switchTab(index) {
            currentActivityIndex = index;
            let entry = trackingData[selectedDateId];
            if (!Array.isArray(entry)) entry = [];

            // Re-render tabs to update highlight
            renderActivityTabs(entry);

            if (index === -1) {
                loadFormEmpty();
            } else {
                loadFormFromEntry(entry[index]);
            }
        }

        function loadFormEmpty(routine) {
            document.getElementById('modalTitle').innerText = "NUEVA ACTIVIDAD";
            document.getElementById('journalInput').value = "";
            document.getElementById('mealsInput').value = "";
            document.getElementById('customTitleInput').value = (routine && routine.title) ? routine.title : "";

            document.getElementById('durationInput').value = "";
            document.getElementById('caloriesInput').value = "";
            document.getElementById('distanceInput').value = "";
            document.getElementById('elevationInput').value = "";

            currentSelectedType = (routine && routine.type) ? routine.type : 'walk';

            // UI
            updateTypeUI(currentSelectedType);

            document.getElementById('completeBtn').innerText = "GUARDAR (NUEVO)";
            document.getElementById('deleteBtn').style.display = 'none';
        }

        function loadFormFromEntry(data) {
            document.getElementById('modalTitle').innerText = data.title || "ACTIVIDAD";
            document.getElementById('journalInput').value = data.note || "";
            document.getElementById('mealsInput').value = data.meals || "";
            document.getElementById('customTitleInput').value = data.title || "";

            document.getElementById('durationInput').value = data.duration || "";
            document.getElementById('caloriesInput').value = data.calories || "";
            document.getElementById('distanceInput').value = data.distance || "";
            document.getElementById('elevationInput').value = data.elevation || "";

            currentSelectedType = data.activityType || 'walk';
            updateTypeUI(currentSelectedType);

            document.getElementById('completeBtn').innerText = "ACTUALIZAR";
            document.getElementById('deleteBtn').style.display = 'block';
        }

        function updateTypeUI(type) {
            document.querySelectorAll('#typeSelector .type-btn').forEach(b => {
                b.classList.remove('active');
                if (b.getAttribute('onclick').includes(`'${type}'`)) {
                    b.classList.add('active');
                }
            });
            selectType(type, document.querySelector(`.type-btn[onclick*="'${type}'"]`));
        }

        function saveActivity() {
            const note = document.getElementById('journalInput').value;
            const meals = document.getElementById('mealsInput').value;
            const title = document.getElementById('customTitleInput').value || "Actividad";
            const duration = document.getElementById('durationInput').value;
            const calories = document.getElementById('caloriesInput').value;
            const distance = document.getElementById('distanceInput').value;
            const elevation = document.getElementById('elevationInput').value;

            const newActivityObj = {
                completed: true,
                activityType: currentSelectedType,
                title: title,
                note: note,
                meals: meals,
                duration: duration ? parseInt(duration) : 0,
                calories: calories ? parseInt(calories) : 0,
                distance: distance ? parseFloat(distance) : 0,
                elevation: elevation ? parseInt(elevation) : 0
            };

            // Get current array
            let entryArray = trackingData[selectedDateId];
            if (!Array.isArray(entryArray)) {
                entryArray = [];
                trackingData[selectedDateId] = entryArray;
            }

            if (currentActivityIndex === -1) {
                // ADD NEW
                entryArray.push(newActivityObj);
            } else {
                // UPDATE EXISTING
                if (entryArray[currentActivityIndex]) {
                    entryArray[currentActivityIndex] = newActivityObj;
                }
            }

            localStorage.setItem('patagoniaFinal_v6', JSON.stringify(trackingData));
            saveToFirestore(); // Sync to Cloud
            closeModal();
            renderCalendar();
            updateStats();
        }

        function deleteActivity() {
            if (confirm("¬øEst√°s seguro de que quieres eliminar esta actividad?")) {
                let entryArray = trackingData[selectedDateId];
                if (Array.isArray(entryArray)) {
                    // Remove at key
                    entryArray.splice(currentActivityIndex, 1);

                    // If empty, delete key? Or keep empty array? Keep array is fine.
                    if (entryArray.length === 0) {
                        delete trackingData[selectedDateId]; // Cleaner to delete key if empty
                    }

                    localStorage.setItem('patagoniaFinal_v6', JSON.stringify(trackingData));
                    saveToFirestore(); // Sync to Cloud
                }
                closeModal();
                renderCalendar();
                updateStats();
            }
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function openSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(trackingData));
            const anchor = document.createElement('a');
            anchor.setAttribute("href", dataStr);
            anchor.setAttribute("download", "patagonia_backup.json");
            document.body.appendChild(anchor);
            anchor.click();
            anchor.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    trackingData = JSON.parse(e.target.result);
                    localStorage.setItem('patagoniaFinal_v6', JSON.stringify(trackingData));
                    saveToFirestore(); // Sync to Cloud
                    alert("Datos cargados.");
                    closeSettings();
                    renderCalendar();
                    updateStats();
                } catch (err) { alert("Error en archivo."); }
            };
            reader.readAsText(file);
        }

        function updateStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const trip = new Date(tripDate);
            trip.setHours(0, 0, 0, 0);

            const oneDay = 24 * 60 * 60 * 1000;
            const diffDays = Math.round((trip - today) / oneDay);

            document.getElementById('daysLeft').innerText = diffDays > 0 ? diffDays : 0;
            document.getElementById('completedCount').innerText = Object.keys(trackingData).length;
            document.getElementById('currentPhaseLabel').innerText = getPhase(today).name;
        }
        // EXPORT GLOBALS FOR MODULE
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.saveActivity = saveActivity;
        window.deleteActivity = deleteActivity;
        window.addActivityToDay = addActivityToDay;
        window.openSettings = openSettings;
        window.closeSettings = closeSettings;
        window.exportData = exportData;
        window.importData = importData;

        window.toggleFilter = toggleFilter;
        window.toggleFilterMenu = toggleFilterMenu;
        window.toggleStats = toggleStats;
        window.switchTab = switchTab;
        window.renderCalendar = renderCalendar;
        window.updateStats = updateStats;
    </script>
</body>

</html>